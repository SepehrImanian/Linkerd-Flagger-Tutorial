# Linkerd MTLS

### mutual authentication

The root certificate is self-signed, meaning that the organization creates it themselves. 
(This approach does not work for one-way TLS on the public Internet because an external certificate authority has to issue those certificates.)

mTLS prevents various kinds of attacks, including:
* On-path attacks
* Spoofing attacks
* Credential stuffing
* Brute force attacks
* Phishing attacks
* Malicious API requests

![mtls](./image/how_mtls_works-what_is_mutual_tls.png)

---------------------------------------------------------------------------------------------------

## Generating your own mTLS root certificates

Linkerd needs a **trust anchor certificate** and an **issuer certificate** with its corresponding key.
When installing with **linkerd install**, these certificates are **automatically generated**.
Alternatively, you can specify your own with the **--identity-** flags.


**ECDSA P-256 algorithm** which is the default for **step** == **openssl ecparam -name prime256v1**

### Trust anchor certificate

**The trust anchor has a limited period of validity: 365 days if generated by linkerd install**

generate the root certificate with its private key:

```bash
step certificate create root.linkerd.cluster.local ca.crt ca.key \
--profile root-ca --no-password --insecure
```
this generates the **ca.crt** and **ca.key** files.


use **--no-password --insecure** to avoid encrypting those files with a passphrase.

**longer-lived** trust anchor certificate, pass the **--not-after** argument **(--not-after=87600h)**.

### Issuer certificate and key

Then generate the intermediate certificate and key pair:

```bash
step certificate create identity.linkerd.cluster.local issuer.crt issuer.key \
--profile intermediate-ca --not-after 8760h --no-password --insecure \
--ca ca.crt --ca-key ca.key
```
This will generate the **issuer.crt** and **issuer.key** files.


### Passing the certificates to Linkerd

```bash
# first, install the Linkerd CRDs
linkerd install --crds | kubectl apply -f -

# install the Linkerd control plane, with the certificates we just generated.
linkerd install \
  --identity-trust-anchors-file ca.crt \
  --identity-issuer-certificate-file issuer.crt \
  --identity-issuer-key-file issuer.key \
  | kubectl apply -f -
```

---------------------------------------------------------------------------------------------------

## Manually Rotating Control Plane TLS Credentials

**this part only applies if the trust anchor is currently valid**

Understanding the current state of your system:

```
linkerd check --proxy
```

Read the current trust anchor certificate from the cluster

```bash
kubectl -n linkerd get cm linkerd-identity-trust-roots -o=jsonpath='{.data.ca-bundle\.crt}' > original-trust-anchors.crt
```

Generate a new trust anchor

```bash
step certificate create root.linkerd.cluster.local ca-new.crt ca-new.key --profile root-ca --no-password --insecure
```




































